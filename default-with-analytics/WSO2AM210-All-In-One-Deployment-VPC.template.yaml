AWSTemplateFormatVersion: 2010-09-09
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Cluster Configuration
        Parameters:
          - KeyPairName
          - AWSAccessKeySecret
      - Label:
          default: Network Configuration
        Parameters:
          - CertificateName
      - Label:
          default: Database Configuration
        Parameters:
          - DBUsername
          - DBPassword
    ParameterLabels:
      AWSAccessKeySecret:
        default: AWS Access Secret Key
      CertificateName:
        default: Which certificate should be used at the Load Balancer for APIM?
      DBUsername:
        default: APIM Database Master username?
      DBPassword:
        default: APIM Database Master password
  'AWS::CloudFormation::Designer':
    d7b7f81e-7749-44d4-97ed-b875c515f79e:
      size:
        width: 60
        height: 60
      position:
        x: 350
        'y': 170
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
    b8ccf92f-6c6a-4757-a123-715919b3e8e6:
      size:
        width: 60
        height: 60
      position:
        x: 340
        'y': -30
      z: 1
      embeds: []
    e9781b4d-5d35-431f-bf45-461b0762310e:
      size:
        width: 780
        height: 690
      position:
        x: 60
        'y': 90
      z: 1
      embeds:
        - d7b7f81e-7749-44d4-97ed-b875c515f79e
        - 9da4e096-674c-4910-8b7f-2ed5bb574bec
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
        - 19d1c7ba-e2e4-4b98-a92c-704de4ed63ea
        - c5d2abef-4470-4242-a839-5960d40cafa2
        - e213afa6-eb1e-4abb-9a7c-15a774056288
        - 35e936db-db15-400b-845c-45ba57d856da
        - 4b8952b7-81a7-475c-82b0-19ad2dd5d2a4
        - 3961b542-c299-436d-bc23-49ec53803d82
        - 74a8c803-8a41-4817-821b-673019cc26a3
        - a424e08a-e8eb-4e6a-8790-202b47b89400
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - 6e5fdb48-66f3-4d90-b348-20c9229ef353
        - 4a241cf0-f4f1-441f-a48e-5804283a101a
        - 9fd157c1-7dcc-4e8f-8423-496c0d548da1
        - 87b54251-2e02-4920-a58d-10c011abf59a
        - d342cd60-ac6a-47de-a209-dbd7aaa8f1ce
        - 93b3c6a7-f22f-4e8c-8832-8aa5dd38d72d
    9da4e096-674c-4910-8b7f-2ed5bb574bec:
      size:
        width: 80
        height: 90
      position:
        x: 210
        'y': 270
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds:
        - b003f7a2-4c5b-42c2-9f14-192fea03047e
    b003f7a2-4c5b-42c2-9f14-192fea03047e:
      size:
        width: 60
        height: 60
      position:
        x: 220
        'y': 290
      z: 3
      parent: 9da4e096-674c-4910-8b7f-2ed5bb574bec
      embeds: []
      references:
        - b8ccf92f-6c6a-4757-a123-715919b3e8e6
    56d490e7-6ce9-426a-a011-13f384ee84bb:
      size:
        width: 80
        height: 90
      position:
        x: 210
        'y': 150
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds:
        - 3aeba790-9453-45f7-8f83-fa2c7d4b4fec
    19072a90-1e25-42cc-87c5-0b3b07121c25:
      source:
        id: 9da4e096-674c-4910-8b7f-2ed5bb574bec
      target:
        id: 56d490e7-6ce9-426a-a011-13f384ee84bb
      z: 2
    5b8cc21a-467b-4303-8e31-1d78bce1866f:
      size:
        width: 60
        height: 60
      position:
        x: 160
        'y': 670
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
    19d1c7ba-e2e4-4b98-a92c-704de4ed63ea:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 370
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    3aeba790-9453-45f7-8f83-fa2c7d4b4fec:
      size:
        width: 60
        height: 60
      position:
        x: 220
        'y': 170
      z: 3
      parent: 56d490e7-6ce9-426a-a011-13f384ee84bb
      embeds: []
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      references:
        - d7b7f81e-7749-44d4-97ed-b875c515f79e
    c5d2abef-4470-4242-a839-5960d40cafa2:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 650
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    1da3097f-056f-47f7-87f3-24288185e7a5:
      source:
        id: b8ccf92f-6c6a-4757-a123-715919b3e8e6
      target:
        id: e9781b4d-5d35-431f-bf45-461b0762310e
      z: 1
    e213afa6-eb1e-4abb-9a7c-15a774056288:
      size:
        width: 80
        height: 90
      position:
        x: 90
        'y': 270
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds:
        - 0b12049c-9197-499b-8dff-0269169c1adf
    0b12049c-9197-499b-8dff-0269169c1adf:
      size:
        width: 60
        height: 60
      position:
        x: 100
        'y': 290
      z: 3
      parent: e213afa6-eb1e-4abb-9a7c-15a774056288
      embeds: []
      references:
        - b8ccf92f-6c6a-4757-a123-715919b3e8e6
    35e936db-db15-400b-845c-45ba57d856da:
      size:
        width: 80
        height: 90
      position:
        x: 90
        'y': 150
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds:
        - 0b210515-5ed5-4cc2-a75c-84d1c95157a3
    4b8952b7-81a7-475c-82b0-19ad2dd5d2a4:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 300
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 35e936db-db15-400b-845c-45ba57d856da
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    3961b542-c299-436d-bc23-49ec53803d82:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 230
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
        - 35e936db-db15-400b-845c-45ba57d856da
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    0b210515-5ed5-4cc2-a75c-84d1c95157a3:
      size:
        width: 60
        height: 60
      position:
        x: 100
        'y': 170
      z: 3
      parent: 35e936db-db15-400b-845c-45ba57d856da
      embeds: []
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      references:
        - d7b7f81e-7749-44d4-97ed-b875c515f79e
    74a8c803-8a41-4817-821b-673019cc26a3:
      size:
        width: 100
        height: 90
      position:
        x: 140
        'y': 460
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds:
        - eee6ef2d-a33e-4b24-8975-071c5e03367e
      isconnectedto:
        - 35e936db-db15-400b-845c-45ba57d856da
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
    eee6ef2d-a33e-4b24-8975-071c5e03367e:
      size:
        width: 60
        height: 60
      position:
        x: 160
        'y': 480
      z: 3
      parent: 74a8c803-8a41-4817-821b-673019cc26a3
      embeds: []
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    a424e08a-e8eb-4e6a-8790-202b47b89400:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 580
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 35e936db-db15-400b-845c-45ba57d856da
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    bc72cddc-4b1f-4176-8e6d-580281df8981:
      size:
        width: 60
        height: 60
      position:
        x: 730
        'y': 510
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
        - 35e936db-db15-400b-845c-45ba57d856da
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
    6e5fdb48-66f3-4d90-b348-20c9229ef353:
      size:
        width: 60
        height: 60
      position:
        x: 440
        'y': 330
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
        - 3961b542-c299-436d-bc23-49ec53803d82
        - 1da3097f-056f-47f7-87f3-24288185e7a5
      isrelatedto:
        - d7b7f81e-7749-44d4-97ed-b875c515f79e
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - eee6ef2d-a33e-4b24-8975-071c5e03367e
    4a241cf0-f4f1-441f-a48e-5804283a101a:
      size:
        width: 60
        height: 60
      position:
        x: 590
        'y': 370
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
        - 3961b542-c299-436d-bc23-49ec53803d82
        - 19d1c7ba-e2e4-4b98-a92c-704de4ed63ea
      isassociatedwith:
        - 6e5fdb48-66f3-4d90-b348-20c9229ef353
      dependson:
        - 6e5fdb48-66f3-4d90-b348-20c9229ef353
        - 3961b542-c299-436d-bc23-49ec53803d82
    9fd157c1-7dcc-4e8f-8423-496c0d548da1:
      size:
        width: 60
        height: 60
      position:
        x: 590
        'y': 300
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 35e936db-db15-400b-845c-45ba57d856da
        - 3961b542-c299-436d-bc23-49ec53803d82
        - 4b8952b7-81a7-475c-82b0-19ad2dd5d2a4
      isassociatedwith:
        - 6e5fdb48-66f3-4d90-b348-20c9229ef353
      dependson:
        - 6e5fdb48-66f3-4d90-b348-20c9229ef353
        - 3961b542-c299-436d-bc23-49ec53803d82
    87b54251-2e02-4920-a58d-10c011abf59a:
      size:
        width: 60
        height: 60
      position:
        x: 440
        'y': 610
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      ismemberof:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
      dependson:
        - 5b8cc21a-467b-4303-8e31-1d78bce1866f
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - 1da3097f-056f-47f7-87f3-24288185e7a5
      isrelatedto:
        - d7b7f81e-7749-44d4-97ed-b875c515f79e
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - eee6ef2d-a33e-4b24-8975-071c5e03367e
    d342cd60-ac6a-47de-a209-dbd7aaa8f1ce:
      size:
        width: 60
        height: 60
      position:
        x: 590
        'y': 650
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 56d490e7-6ce9-426a-a011-13f384ee84bb
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - c5d2abef-4470-4242-a839-5960d40cafa2
      dependson:
        - 87b54251-2e02-4920-a58d-10c011abf59a
        - bc72cddc-4b1f-4176-8e6d-580281df8981
    93b3c6a7-f22f-4e8c-8832-8aa5dd38d72d:
      size:
        width: 60
        height: 60
      position:
        x: 590
        'y': 580
      z: 2
      parent: e9781b4d-5d35-431f-bf45-461b0762310e
      embeds: []
      isconnectedto:
        - 35e936db-db15-400b-845c-45ba57d856da
        - bc72cddc-4b1f-4176-8e6d-580281df8981
        - a424e08a-e8eb-4e6a-8790-202b47b89400
      dependson:
        - 87b54251-2e02-4920-a58d-10c011abf59a
        - bc72cddc-4b1f-4176-8e6d-580281df8981
    2a08f07e-74e3-4397-ac0b-c62fbe2db4a9:
      source:
        id: e213afa6-eb1e-4abb-9a7c-15a774056288
      target:
        id: 35e936db-db15-400b-845c-45ba57d856da
      z: 2
Resources:
  WSO2AM1SIMPLE1VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e9781b4d-5d35-431f-bf45-461b0762310e
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
      CidrBlock: 10.0.254.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - '0'
        - !GetAZs ''
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 35e936db-db15-400b-845c-45ba57d856da
  PublicInternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b8ccf92f-6c6a-4757-a123-715919b3e8e6
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e213afa6-eb1e-4abb-9a7c-15a774056288
  EC2SRTA4ALO8:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2a08f07e-74e3-4397-ac0b-c62fbe2db4a9
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      GatewayId: !Ref PublicInternetGateway
      DestinationCidrBlock: 0.0.0.0/0
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0b12049c-9197-499b-8dff-0269169c1adf
  EC2VPCG1W38G:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref PublicInternetGateway
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 1da3097f-056f-47f7-87f3-24288185e7a5
  WSO2AMLC:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - Ubuntu140464bit
      InstanceType: t2.medium
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: '20'
            VolumeType: gp2
            DeleteOnTermination: 'true'
      KeyName: !Ref KeyPairName
      SecurityGroups:
        - !Ref ProductSecurityGroup
      UserData: !Base64
        'Fn::Join':
          - |+

          - - '#!/bin/bash'
            - set -e
            - mkdir -p /mnt/efs
            - !Join
              - ''
              - - echo "
                - !Ref AMNFSMount
                - .efs.
                - !Ref 'AWS::Region'
                - .amazonaws.com
                - >-
                  :/ /mnt/efs nfs4
                  nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
                  0 0" >> /etc/fstab
            - !Join
              - ''
              - - sed -i "s/CF_ELB_DNS_NAME/
                - !GetAtt
                  - WSO2AMELB
                  - DNSName
                - >-
                  /g"
                  /etc/puppet/hieradata/dev/wso2/wso2am_runtime/pattern-1/default.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_USERNAME/
                - !Ref DBUsername
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_PASSWORD/
                - !Ref DBPassword
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - !Join
              - ''
              - - sed -i "s/CF_RDS_URL/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - mount -a -t nfs4
            - export DB_NAME=WSO2AM_DB
            - !Join
              - ''
              - - export DB_HOSTNAME=
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
            - !Join
              - ''
              - - export DB_PORT=
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Port
            - !Join
              - ''
              - - export DB_USERNAME=
                - !Ref DBUsername
            - !Join
              - ''
              - - export DB_PASSWORD=
                - !Ref DBPassword
            - echo "Waiting for Cluster lock..."
            - bash /usr/local/bin/acquire_lock.sh
            - export FACTER_product_name=wso2am_runtime
            - export FACTER_product_version=2.1.0
            - export FACTER_product_profile=default
            - export FACTER_vm_type=openstack
            - export FACTER_environment=dev
            - export FACTER_platform=default
            - export FACTER_use_hieradata=true
            - export FACTER_pattern=pattern-1
            - >-
              puppet apply -e "include wso2am_runtime"
              --modulepath=/etc/puppet/modules
              --hiera_config=/etc/puppet/hiera.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_USERNAME/
                - !Ref DBUsername
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_PASSWORD/
                - !Ref DBPassword
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_HOST/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_PORT/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Port
                - /g" /usr/local/bin/provision_db_apim.sh
            - bash /usr/local/bin/provision_db_apim.sh
            - echo "Releasing lock..."
            - /usr/local/bin/sync_lock apim unlock
            - 'if [ ! -d "/mnt/efs/synapse-configs" ]; then'
            - '    mkdir -p /mnt/efs/synapse-configs'
            - '    cp -r /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs /mnt/efs/synapse-configs'
            - fi
            - >-
              rm -rf
              /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs
            - >-
              ln -s /mnt/efs/synapse-configs/synapse-configs
              /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs
            - apt-get --purge remove puppet mysql-client -y
            - rm -rf /etc/puppet
            - /mnt/wso2am-2.1.0/bin/wso2server.sh start
            - echo 'export HISTTIMEFORMAT="%F %T "' >> /etc/profile.d/history.sh
            - cat /dev/null > ~/.bash_history && history -c
    DependsOn:
      - ProductSecurityGroup
      - WSO2AMELB
      - EC2VPCG1W38G
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 87b54251-2e02-4920-a58d-10c011abf59a
  ProductSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Product Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '2049'
          ToPort: '2049'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9443'
          ToPort: '9443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5701'
          ToPort: '5701'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9763'
          ToPort: '9763'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8243'
          ToPort: '8243'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8280'
          ToPort: '8280'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          CidrIp: 0.0.0.0/0
        - IpProtocol: ICMP
          FromPort: '-1'
          ToPort: '-1'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '10389'
          ToPort: '10389'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8000'
          ToPort: '8000'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5701'
          ToPort: '5701'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5672'
          ToPort: '5672'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9611'
          ToPort: '9611'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9711'
          ToPort: '9711'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '10397'
          ToPort: '10397'
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: '0'
          ToPort: '0'
          CidrIp: 0.0.0.0/0
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 5b8cc21a-467b-4303-8e31-1d78bce1866f
  WSO2AMELB:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet2
        - !Ref PublicSubnet
      LBCookieStickinessPolicy:
        - PolicyName: LBStickyPolicy
      Listeners:
        - LoadBalancerPort: '9443'
          InstancePort: '9443'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          PolicyNames:
            - LBStickyPolicy
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '8243'
          InstancePort: '8243'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          PolicyNames:
            - LBStickyPolicy
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '9763'
          InstancePort: '9763'
          Protocol: HTTP
          InstanceProtocol: HTTP
          PolicyNames:
            - LBStickyPolicy
        - LoadBalancerPort: '10389'
          InstancePort: '10389'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '8000'
          InstancePort: '8000'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5701'
          InstancePort: '5701'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5672'
          InstancePort: '5672'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9611'
          InstancePort: '9611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9711'
          InstancePort: '9711'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '10397'
          InstancePort: '10397'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: bc72cddc-4b1f-4176-8e6d-580281df8981
  WSO2AMELBThriftSN1:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet
      Listeners:
        - LoadBalancerPort: '9611'
          InstancePort: '9611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9711'
          InstancePort: '9711'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a424e08a-e8eb-4e6a-8790-202b47b89400
  WSO2AMELBThriftSN2:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet2
      Listeners:
        - LoadBalancerPort: '9611'
          InstancePort: '9611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9711'
          InstancePort: '9711'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c5d2abef-4470-4242-a839-5960d40cafa2
  WSO2AMDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      VPCSecurityGroups:
        - !Ref ProductSecurityGroup
      DBInstanceClass: db.t2.medium
      AllocatedStorage: 5
      BackupRetentionPeriod: '0'
      DBInstanceIdentifier: wso2amdb
      DBName: WSO2AM_DB
      Engine: MySQL
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      MultiAZ: 'false'
      StorageType: gp2
      DBSubnetGroupName: !Ref RDSDBSG412ZQ
    Metadata:
      'AWS::CloudFormation::Designer':
        id: eee6ef2d-a33e-4b24-8975-071c5e03367e
  RDSDBSG412ZQ:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: DB Subnet Group
      SubnetIds:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 74a8c803-8a41-4817-821b-673019cc26a3
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
      CidrBlock: 10.0.252.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - '1'
        - !GetAZs ''
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 56d490e7-6ce9-426a-a011-13f384ee84bb
  PublicRouteTable2:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9da4e096-674c-4910-8b7f-2ed5bb574bec
  PublicRoute2:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable2
      GatewayId: !Ref PublicInternetGateway
      DestinationCidrBlock: 0.0.0.0/0
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b003f7a2-4c5b-42c2-9f14-192fea03047e
  EC2SRTA21VEF:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable2
      SubnetId: !Ref PublicSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 19072a90-1e25-42cc-87c5-0b3b07121c25
  AMNFSMount:
    Type: 'AWS::EFS::FileSystem'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d7b7f81e-7749-44d4-97ed-b875c515f79e
  EFSMtSN1:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      SubnetId: !Ref PublicSubnet
      FileSystemId: !Ref AMNFSMount
      SecurityGroups:
        - !Ref ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0b210515-5ed5-4cc2-a75c-84d1c95157a3
  EFSMtSN2:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      SubnetId: !Ref PublicSubnet2
      FileSystemId: !Ref AMNFSMount
      SecurityGroups:
        - !Ref ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3aeba790-9453-45f7-8f83-fa2c7d4b4fec
  WSO2AMAnalyticsASGSN1:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      LaunchConfigurationName: !Ref WSO2AMAnalyticsLC
      DesiredCapacity: 1
      MinSize: 1
      MaxSize: 1
      LoadBalancerNames:
        - !Ref WSO2AMAnalyticsELB
        - !Ref WSO2AMAnalyticsELBThriftSN1
      VPCZoneIdentifier:
        - !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: WSO2AM-Analytics-Instance
          PropagateAtLaunch: 'true'
        - Key: Product
          Value: WSO2AM-Analytics
          PropagateAtLaunch: 'true'
        - Key: Version
          Value: 2.1.0
          PropagateAtLaunch: 'true'
        - Key: Cluster
          Value: WSO2AMAnalytics210SIMPLE
          PropagateAtLaunch: 'true'
    DependsOn:
      - WSO2AMAnalyticsLC
      - WSO2AMAnalyticsELB
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9fd157c1-7dcc-4e8f-8423-496c0d548da1
  WSO2AMAnalyticsASGSN2:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      LaunchConfigurationName: !Ref WSO2AMAnalyticsLC
      DesiredCapacity: 1
      MinSize: 1
      MaxSize: 2
      LoadBalancerNames:
        - !Ref WSO2AMAnalyticsELB
        - !Ref WSO2AMAnalyticsELBThriftSN2
      VPCZoneIdentifier:
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: WSO2AM-Analytics-Instance
          PropagateAtLaunch: 'true'
        - Key: Product
          Value: WSO2AM-Analytics
          PropagateAtLaunch: 'true'
        - Key: Version
          Value: 2.1.0
          PropagateAtLaunch: 'true'
        - Key: Cluster
          Value: WSO2AMAnalytics210SIMPLE
          PropagateAtLaunch: 'true'
    DependsOn:
      - WSO2AMAnalyticsLC
      - WSO2AMAnalyticsELB
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4a241cf0-f4f1-441f-a48e-5804283a101a
  WSO2AMAnalyticsLC:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      ImageId: !FindInMap
        - AWSAnalyticsAMIRegionMap
        - !Ref 'AWS::Region'
        - Ubuntu140464bit
      InstanceType: t2.medium
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: '20'
            VolumeType: gp2
            DeleteOnTermination: 'true'
      KeyName: !Ref KeyPairName
      SecurityGroups:
        - !Ref ProductSecurityGroup
      UserData: !Base64
        'Fn::Join':
          - |+

          - - '#!/bin/bash'
            - set -e
            - mkdir -p /mnt/efs
            - !Join
              - ''
              - - echo "
                - !Ref AMNFSMount
                - .efs.
                - !Ref 'AWS::Region'
                - .amazonaws.com
                - >-
                  :/ /mnt/efs nfs4
                  nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
                  0 0" >> /etc/fstab
            - !Join
              - ''
              - - sed -i "s/CF_ELB_DNS_NAME/
                - !GetAtt
                  - WSO2AMELB
                  - DNSName
                - >-
                  /g"
                  /etc/puppet/hieradata/dev/wso2/wso2am_runtime/pattern-1/default.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_USERNAME/
                - !Ref DBUsername
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_PASSWORD/
                - !Ref DBPassword
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - !Join
              - ''
              - - sed -i "s/CF_RDS_URL/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - /g" /etc/puppet/hieradata/dev/wso2/common.yaml
            - mount -a -t nfs4
            - export DB_NAME=WSO2AM_DB
            - !Join
              - ''
              - - export DB_HOSTNAME=
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
            - !Join
              - ''
              - - export DB_PORT=
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Port
            - !Join
              - ''
              - - export DB_USERNAME=
                - !Ref DBUsername
            - !Join
              - ''
              - - export DB_PASSWORD=
                - !Ref DBPassword
            - echo "Waiting for Cluster lock..."
            - bash /usr/local/bin/acquire_lock.sh
            - export FACTER_product_name=wso2am_runtime
            - export FACTER_product_version=2.1.0
            - export FACTER_product_profile=default
            - export FACTER_vm_type=openstack
            - export FACTER_environment=dev
            - export FACTER_platform=default
            - export FACTER_use_hieradata=true
            - export FACTER_pattern=pattern-1
            - >-
              puppet apply -e "include wso2am_runtime"
              --modulepath=/etc/puppet/modules
              --hiera_config=/etc/puppet/hiera.yaml
            - !Join
              - ''
              - - sed -i "s/CF_DB_USERNAME/
                - !Ref DBUsername
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_PASSWORD/
                - !Ref DBPassword
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_HOST/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - /g" /usr/local/bin/provision_db_apim.sh
            - !Join
              - ''
              - - sed -i "s/CF_DB_PORT/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Port
                - /g" /usr/local/bin/provision_db_apim.sh
            - bash /usr/local/bin/provision_db_apim.sh
            - echo "Releasing lock..."
            - /usr/local/bin/sync_lock apim unlock
            - 'if [ ! -d "/mnt/efs/synapse-configs" ]; then'
            - '    mkdir -p /mnt/efs/synapse-configs'
            - '    cp -r /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs /mnt/efs/synapse-configs'
            - fi
            - >-
              rm -rf
              /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs
            - >-
              ln -s /mnt/efs/synapse-configs/synapse-configs
              /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs
            - apt-get --purge remove puppet mysql-client -y
            - rm -rf /etc/puppet
            - /mnt/wso2am-2.1.0/bin/wso2server.sh start
            - echo 'export HISTTIMEFORMAT="%F %T "' >> /etc/profile.d/history.sh
            - cat /dev/null > ~/.bash_history && history -c
    DependsOn:
      - ProductSecurityGroup
      - WSO2AMAnalyticsELB
      - EC2VPCG1W38G
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 6e5fdb48-66f3-4d90-b348-20c9229ef353
  WSO2AMAnalyticsELB:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet2
        - !Ref PublicSubnet
      LBCookieStickinessPolicy:
        - PolicyName: LBStickyPolicy
      Listeners:
        - LoadBalancerPort: '9443'
          InstancePort: '9443'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          PolicyNames:
            - LBStickyPolicy
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '8243'
          InstancePort: '8243'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          PolicyNames:
            - LBStickyPolicy
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '9763'
          InstancePort: '9763'
          Protocol: HTTP
          InstanceProtocol: HTTP
          PolicyNames:
            - LBStickyPolicy
        - LoadBalancerPort: '10389'
          InstancePort: '10389'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '8000'
          InstancePort: '8000'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5701'
          InstancePort: '5701'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5672'
          InstancePort: '5672'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9611'
          InstancePort: '9611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9711'
          InstancePort: '9711'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '10397'
          InstancePort: '10397'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3961b542-c299-436d-bc23-49ec53803d82
  WSO2AMAnalyticsELBThriftSN1:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet
      LBCookieStickinessPolicy:
        - PolicyName: LBStickyPolicy
      Listeners:
        - LoadBalancerPort: '7611'
          InstancePort: '7611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '7711'
          InstancePort: '7711'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4b8952b7-81a7-475c-82b0-19ad2dd5d2a4
  WSO2AMAnalyticsELBThriftSN2:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet2
      LBCookieStickinessPolicy:
        - PolicyName: LBStickyPolicy
      Listeners:
        - LoadBalancerPort: '7611'
          InstancePort: '7611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '7711'
          InstancePort: '7711'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    DependsOn:
      - ProductSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 19d1c7ba-e2e4-4b98-a92c-704de4ed63ea
Outputs:
  Publisher:
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt
          - WSO2AMELB
          - DNSName
        - ':9443/publisher'
    Description: WSO2 API Manager Publisher URL.
  Store:
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt
          - WSO2AMELB
          - DNSName
        - ':9443/store'
    Description: WSO2 API Manager Store URL.
  Carbon:
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt
          - WSO2AMELB
          - DNSName
        - ':9443/carbon'
    Description: WSO2 API Manager Console URL.
  Credentials:
    Value: !Join
      - ''
      - - 'Username: admin, '
        - 'Password: admin'
    Description: >-
      WSO2 API Manager Admin Credentials. Please refer
      https://docs.wso2.com/display/AM210/Maintaining+Logins+and+passwords to
      change credentials.
Parameters:
  KeyPairName:
    Description: >-
      The key pair to establish a SSH connection to the web servers. This should
      be already created.
    Type: 'AWS::EC2::KeyPair::KeyName'
  CertificateName:
    Description: A previously uploaded certificate to use at the Load Balancer Listeners.
    Type: String
    MinLength: 1
  DBUsername:
    Description: The username to be used in the WSO2 AM DB.
    Type: String
    Default: root
    MinLength: 4
    AllowedPattern: '[A-Za-z0-9\-]+'
  DBPassword:
    Description: The password to be used in the WSO2 AM DB.
    Type: String
    Default: rootrootroot
    MinLength: 8
    NoEcho: true
Conditions: {}
Mappings:
  AWSAMIRegionMap:
    ap-northeast-1:
      Ubuntu140464bit: ami-2e63924f
    ap-northeast-2:
      Ubuntu140464bit: ami-979258f9
    ap-south-1:
      Ubuntu140464bit: ami-4a90fa25
    ap-southeast-1:
      Ubuntu140464bit: ami-ea2bf989
    ap-southeast-2:
      Ubuntu140464bit: ami-396a415a
    eu-central-1:
      Ubuntu140464bit: ami-4bd03b24
    eu-west-1:
      Ubuntu140464bit: ami-02b62c71
    eu-west-2:
      Ubuntu140464bit: ami-63342007
    us-east-1:
      Ubuntu140464bit: ami-a9e2a9bf
    us-east-2:
      Ubuntu140464bit: ami-151d3b70
    us-west-1:
      Ubuntu140464bit: ami-992661f9
    us-west-2:
      Ubuntu140464bit: ami-42569022
    ca-central-1:
      Ubuntu140464bit: ami-beea56da
    sa-east-1:
      Ubuntu140464bit: ami-8df695e1
  AWSAnalyticsAMIRegionMap:
    ap-northeast-1:
      Ubuntu140464bit: ami-2e63924f
    ap-northeast-2:
      Ubuntu140464bit: ami-979258f9
    ap-south-1:
      Ubuntu140464bit: ami-4a90fa25
    ap-southeast-1:
      Ubuntu140464bit: ami-ea2bf989
    ap-southeast-2:
      Ubuntu140464bit: ami-396a415a
    eu-central-1:
      Ubuntu140464bit: ami-4bd03b24
    eu-west-1:
      Ubuntu140464bit: ami-02b62c71
    eu-west-2:
      Ubuntu140464bit: ami-63342007
    us-east-1:
      Ubuntu140464bit: ami-a9e2a9bf
    us-east-2:
      Ubuntu140464bit: ami-151d3b70
    us-west-1:
      Ubuntu140464bit: ami-992661f9
    us-west-2:
      Ubuntu140464bit: ami-42569022
    ca-central-1:
      Ubuntu140464bit: ami-beea56da
    sa-east-1:
      Ubuntu140464bit: ami-8df695e1
